<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Notes by albertisement</title>
    <link rel="stylesheet" href="notes.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="icon" type="image/png" sizes="16x16" href="favicon.png">
    <link rel="stylesheet" href="assets/fonts/flaticon/uicons-regular-rounded.css">
    <link href="https://fonts.googleapis.com/css2?family=ABeeZee&display=swap" rel="stylesheet">
</head>
<body>

<div id="main">
    <div class="center-box">
        <form id="_login_form" method="post" onsubmit="arguments[0].preventDefault()">
            <input id="_username" type="text" maxlength="10" required>
            <input id="_password" type="password" maxlength="15" required>
            <button type="submit">Login</button>
        </form>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
<script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-analytics.js";
    import { getDatabase, ref, child, set, get, update, onValue } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";
    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries

    // Your web app's Firebase configuration
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
        apiKey: "AIzaSyA6Me-DdLQBeCG0-tNwEogmYxYopGiyN-U",
        authDomain: "notes-c0941.firebaseapp.com",
        projectId: "notes-c0941",
        storageBucket: "notes-c0941.appspot.com",
        messagingSenderId: "339894615538",
        appId: "1:339894615538:web:7181064691aef9080ebf6b",
        measurementId: "G-6F0MXBM8WK"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    let dbRef = `notes_project/users/`
    let dataCount = 0;
    let notes = ref(database, dbRef);
    let body = $('body');

    checkSession();

    $("#_login_form").on('submit', function () {
        let uname = $('#_username');
        let pwd = $('#_password');

        let userHash = encryptUserCred(uname.val(), pwd.val());
        // console.log(userHash);
        // return;

        onValue(notes, (snapshot) => {
            const data = snapshot.val();
            if (!!data) {
                dataCount = Object.keys(data).length;
            } else {
                console.log('No data available');
            }

            snapshot.forEach((childSnapshot) => {
                const childKey = childSnapshot.key;
                if (childKey === userHash) {
                    sessionStorage.setItem('_notes_user_hash', userHash);
                    window.location.replace('notes.html');
                    return true;
                }
            });
        });
    });

    function encryptUserCred(username, password) {
        return btoa(btoa(username + password));
    }

    async function checkUserData(userHash) {
        return set(ref(database, dbRef + userHash), {})
            .then(function () {
                return true;
            })
            .catch(function (e) {
                return false;
            });
    }

    function getUserHash() {
        return sessionStorage.getItem('_notes_user_hash');
    }

    function randomString(length, chars = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ') {
        let result = '';
        for (let i = length; i > 0; --i) result += chars[Math.floor(Math.random() * chars.length)];
        return result;
    }

    function clearFields() {
        addNoteTitle.val('');
        addNoteContent.val('');
        addNoteHash.val('');
    }

    function checkSession() {
        onValue(notes, (snapshot) => {
            const data = snapshot.val();
            if (!!data) {
                dataCount = Object.keys(data).length;
            } else {
                console.log('No session available');
            }

            let hasSession = false;
            snapshot.forEach((childSnapshot) => {
                const childKey = childSnapshot.key;
                if (childKey === sessionStorage.getItem('_notes_user_hash')) {
                    hasSession = true;
                }
            });

            if (hasSession) {
                window.location.replace('notes.html');
                return true;
            }
        });
    }

</script>
</body>
</html>